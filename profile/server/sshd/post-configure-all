# enable random generator so that we have entropy when generating host keys
cat >> /etc/modules <<EOF
# load hw-rng module to make it possible to generate ssh-host-keys on boot
bcm2708_rng
EOF

# cleanup fake ssh keys
for key in ${SSH_HOST_KEYS}; do
  rm "${CHROOTDIR}/etc/ssh/$key"
done;

# allow root login via ssh
sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' "${CHROOTDIR}/etc/ssh/sshd_config"

# install systemd files
install -D -m=0644 "${HOOKDIR}/files/generate-host-keys.service" "${CHROOTDIR}/etc/systemd/system/generate-host-keys.service"
install -D -m=0644 "${HOOKDIR}/files/tty-after-keygen.conf" "${CHROOTDIR}/etc/systemd/system/getty@.service.d/tty-after-keygen.conf"
install -D -m=0644 "${HOOKDIR}/files/keygen-first.conf" "${CHROOTDIR}/etc/systemd/system/ssh@.service.d/keygen-first.conf"
install -D -m=0644 "${HOOKDIR}/files/keygen-first.conf" "${CHROOTDIR}/etc/systemd/system/ssh.service.d/keygen-first.conf"

${IN_CHROOT} systemctl enable generate-host-keys.service

# install genissue script
install -D "${HOOKDIR}/files/genissue" "${CHROOTDIR}/usr/local/bin/genissue"
